name: Release and Publish

on:
  push:
    tags:
      - "v*"
      - "slider-v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Create GitHub releases
      id-token: write # OIDC for npm publishing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Determine package to publish
        id: package
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          if [[ $TAG == slider-v* ]]; then
            echo "name=@atomictemplate/slider" >> $GITHUB_OUTPUT
            echo "path=packages/slider" >> $GITHUB_OUTPUT
            echo "version=${TAG#slider-v}" >> $GITHUB_OUTPUT
            echo "type=slider" >> $GITHUB_OUTPUT
          else
            echo "name=create-atomictemplate" >> $GITHUB_OUTPUT
            echo "path=cli" >> $GITHUB_OUTPUT
            echo "version=${TAG#v}" >> $GITHUB_OUTPUT
            echo "type=cli" >> $GITHUB_OUTPUT
          fi

      # Build template (for CLI releases)
      - name: Build template
        if: steps.package.outputs.type == 'cli'
        run: pnpm build

      # Build slider package
      - name: Build slider package
        if: steps.package.outputs.type == 'slider'
        run: |
          cd packages/slider
          pnpm install
          pnpm build

      # Update version and publish
      - name: Update package version
        run: |
          cd ${{ steps.package.outputs.path }}
          npm version ${{ steps.package.outputs.version }} --no-git-tag-version

      - name: Publish ${{ steps.package.outputs.name }} to npm
        run: |
          cd ${{ steps.package.outputs.path }}
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Create GitHub Release for CLI
      - name: Create GitHub Release (CLI)
        if: steps.package.outputs.type == 'cli'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package.outputs.version }}
          name: Release v${{ steps.package.outputs.version }}
          body: |
            ## ðŸš€ AtomicTemplate v${{ steps.package.outputs.version }}

            ### Installation
            ```bash
            npx create-atomictemplate@${{ steps.package.outputs.version }} my-project
            ```

            ### Quick Start
            ```bash
            npx create-atomictemplate my-project
            cd my-project
            pnpm install
            pnpm dev
            ```

            ### Documentation
            - ðŸ“š [Full Documentation](https://github.com/nomanjawad/atomictemplate#readme)
            - ðŸŽ¯ [Quick Start Guide](https://github.com/nomanjawad/atomictemplate/blob/main/docs/01-getting-started/quick-start.md)

            ### What's New
            See [CHANGELOG.md](https://github.com/nomanjawad/atomictemplate/blob/main/CHANGELOG.md) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create GitHub Release for Slider
      - name: Create GitHub Release (Slider)
        if: steps.package.outputs.type == 'slider'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: slider-v${{ steps.package.outputs.version }}
          name: "@atomictemplate/slider v${{ steps.package.outputs.version }}"
          body: |
            ## ðŸŽ  @atomictemplate/slider v${{ steps.package.outputs.version }}

            ### Installation
            ```bash
            npm install @atomictemplate/slider gsap
            # or
            pnpm add @atomictemplate/slider gsap
            ```

            ### Usage
            ```tsx
            import { Slider } from '@atomictemplate/slider'

            <Slider
              items={slides}
              options={{
                slidesToShow: 3,
                autoplay: { enabled: true },
                loop: true,
              }}
            />
            ```

            ### Features
            - âœ… GSAP-powered animations
            - âœ… Lazy loading with IntersectionObserver
            - âœ… Full keyboard navigation
            - âœ… ARIA accessibility
            - âœ… Touch/swipe support
            - âœ… Autoplay with pause on hover
            - âœ… Marquee mode
            - âœ… Responsive breakpoints
            - âœ… Video/GIF/Lottie support
            - âœ… Render props for customization

            ### Documentation
            - ðŸ“š [Slider Documentation](https://github.com/nomanjawad/atomictemplate/tree/main/packages/slider#readme)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
